# Makefile for Phase 3_2 Training (Kernel Fusion + Batching)

NVCC = nvcc
NVCC_FLAGS = -std=c++11 -arch=sm_75 -O3

# Directories
PHASE3_V2_DIR = ../../phase3_gpu_optimized_v2
TRAIN_DIR = ..
TQDM_DIR = ../../tqdm

# Include paths
INCLUDES = -I$(PHASE3_V2_DIR)/Include \
           -I$(TRAIN_DIR)/include \
           -I$(TQDM_DIR)

# Source files
TRAIN_SRC = train_phase3_v2.cu
PHASE3_V2_KERNELS = $(PHASE3_V2_DIR)/src/kernels/im2col.cu \
                    $(PHASE3_V2_DIR)/src/kernels/gemm.cu \
                    $(PHASE3_V2_DIR)/src/kernels/relu.cu \
                    $(PHASE3_V2_DIR)/src/kernels/maxpool.cu \
                    $(PHASE3_V2_DIR)/src/kernels/upsample.cu

TRAIN_KERNELS = $(TRAIN_DIR)/src/kernels/conv2d_backward.cu \
                $(TRAIN_DIR)/src/kernels/relu_backward.cu \
                $(TRAIN_DIR)/src/kernels/maxpool_backward.cu \
                $(TRAIN_DIR)/src/kernels/upsample_backward.cu \
                $(TRAIN_DIR)/src/kernels/mse_loss.cu

TRAIN_UTILS = $(TRAIN_DIR)/src/sgd_optimizer.cu \
              $(TRAIN_DIR)/src/data_loader.cpp \
              $(TRAIN_DIR)/src/logger.cpp

TQDM_SRC = $(TQDM_DIR)/tqdm.cpp

# Output
TARGET = train_phase3_v2

all: $(TARGET)

$(TARGET): $(TRAIN_SRC) $(PHASE3_V2_KERNELS) $(TRAIN_KERNELS) $(TRAIN_UTILS) $(TQDM_SRC)
	@echo "Compiling Phase 3_2 Training (Kernel Fusion + Batching)..."
	$(NVCC) $(NVCC_FLAGS) $(INCLUDES) \
		$(TRAIN_SRC) \
		$(PHASE3_V2_KERNELS) \
		$(TRAIN_KERNELS) \
		$(TRAIN_UTILS) \
		$(TQDM_SRC) \
		-o $(TARGET)
	@echo "Build complete: $(TARGET)"

clean:
	rm -f $(TARGET)
	rm -f logs/*.log
	@echo "Cleaned build files"

run: $(TARGET)
	./$(TARGET)

.PHONY: all clean run
